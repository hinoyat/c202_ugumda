<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ì•Œë¦¼ ìˆ˜ì‹  í…ŒìŠ¤íŠ¸</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }

        /* í—¤ë” ì˜ì—­ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        h2 {
            margin: 0;
            color: #333;
        }

        /* ì•Œë¦¼ ë¡œê·¸ ì˜ì—­ */
        #log {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* ë¡œê·¸ í•­ëª© ìŠ¤íƒ€ì¼ */
        .log-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            position: relative;
        }

        .alarm-log {
            border-left: 4px solid #4CAF50;
            background-color: #f1f8e9;
        }

        .error-log {
            border-left: 4px solid #F44336;
            background-color: #ffebee;
        }

        .info-log {
            border-left: 4px solid #2196F3;
            background-color: #e3f2fd;
        }

        .log-timestamp {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .control-panel {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button {
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .danger-btn {
            background-color: #f44336;
        }

        .danger-btn:hover {
            background-color: #e53935;
        }

        .info-btn {
            background-color: #2196F3;
        }

        .info-btn:hover {
            background-color: #1e88e5;
        }

        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[type="number"], input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 100px;
        }

        /* ìƒíƒœ ë°°ì§€ */
        #statusBadge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .connected {
            background-color: #4CAF50;
            color: white;
        }

        .disconnected {
            background-color: #F44336;
            color: white;
        }

        .connecting {
            background-color: #FFC107;
            color: black;
        }

        /* ì½ì§€ ì•Šì€ ì•Œë¦¼ ì¹´ìš´í„° */
        #unreadCount {
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-weight: 500;
        }

        /* ì•Œë¦¼ íƒ­ */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }

        .tab.active {
            border-bottom-color: #4CAF50;
            background-color: #f1f8e9;
            font-weight: 500;
        }
    </style>
</head>
<body>
<div class="header">
    <h2>ğŸ”” ì‹¤ì‹œê°„ ì•Œë¦¼ ìˆ˜ì‹  í…ŒìŠ¤íŠ¸</h2>
    <span id="statusBadge" class="disconnected">ì—°ê²° ì•ˆë¨</span>
</div>

<div class="control-panel">
    <div class="control-group">
        <input type="number" id="userIdInput" value="1" min="1" placeholder="ì‚¬ìš©ì ID">
        <button id="connectButton">ì—°ê²°</button>
        <button id="disconnectButton" disabled>ì—°ê²° ëŠê¸°</button>
        <button id="clearButton" class="info-btn">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>
    <div class="control-group">
        <button id="pingButton" disabled>Ping í…ŒìŠ¤íŠ¸</button>
        <button id="markAllReadButton" disabled>ëª¨ë‘ ì½ìŒ ì²˜ë¦¬</button>
        <button id="deleteAllButton" class="danger-btn" disabled>ëª¨ë“  ì•Œë¦¼ ì‚­ì œ</button>
    </div>
</div>

<div id="unreadCount">ì½ì§€ ì•Šì€ ì•Œë¦¼: 0ê°œ</div>

<div class="tabs">
    <div class="tab active" data-tab="log">ì‹¤ì‹œê°„ ë¡œê·¸</div>
    <div class="tab" data-tab="notifications">ì•Œë¦¼ ëª©ë¡</div>
</div>

<div id="log"></div>
<div id="notificationsList" style="display: none;"></div>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let eventSource = null;
    let userId = 1;
    let retryCount = 0;
    let maxRetry = 5;
    let retryInterval = 3000; // 3ì´ˆ
    let reconnectTimeout = null;
    let activeTab = 'log';

    // API ê¸°ë³¸ URL - í™˜ê²½ì— ë”°ë¼ ë³€ê²½
    const API_BASE_URL = 'http://localhost:8085/notifications';

    // DOM ìš”ì†Œ
    const logBox = document.getElementById("log");
    const notificationsListBox = document.getElementById("notificationsList");
    const userIdInput = document.getElementById("userIdInput");
    const connectButton = document.getElementById("connectButton");
    const disconnectButton = document.getElementById("disconnectButton");
    const clearButton = document.getElementById("clearButton");
    const pingButton = document.getElementById("pingButton");
    const markAllReadButton = document.getElementById("markAllReadButton");
    const deleteAllButton = document.getElementById("deleteAllButton");
    const statusBadge = document.getElementById("statusBadge");
    const unreadCountDiv = document.getElementById("unreadCount");
    const tabs = document.querySelectorAll('.tab');

    // íƒ­ ì „í™˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            activeTab = tab.dataset.tab;

            if (activeTab === 'log') {
                logBox.style.display = 'block';
                notificationsListBox.style.display = 'none';
            } else {
                logBox.style.display = 'none';
                notificationsListBox.style.display = 'block';
                loadNotifications();
            }
        });
    });

    /**
     * ì—°ê²° ìƒíƒœ UI ì—…ë°ì´íŠ¸
     */
    function updateStatus(status) {
        statusBadge.className = status;
        switch(status) {
            case 'connected':
                statusBadge.textContent = 'ì—°ê²°ë¨';
                connectButton.disabled = true;
                disconnectButton.disabled = false;
                pingButton.disabled = false;
                markAllReadButton.disabled = false;
                deleteAllButton.disabled = false;
                break;
            case 'disconnected':
                statusBadge.textContent = 'ì—°ê²° ì•ˆë¨';
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                pingButton.disabled = true;
                markAllReadButton.disabled = true;
                deleteAllButton.disabled = true;
                break;
            case 'connecting':
                statusBadge.textContent = 'ì—°ê²° ì¤‘...';
                connectButton.disabled = true;
                disconnectButton.disabled = true;
                pingButton.disabled = true;
                markAllReadButton.disabled = true;
                deleteAllButton.disabled = true;
                break;
        }
    }

    /**
     * ë¡œê·¸ í•­ëª© ì¶”ê°€
     */
    function addLog(message, type = 'info') {
        const logEntry = document.createElement('div');
        logEntry.className = `log-item ${type}-log`;

        const timestamp = document.createElement('div');
        timestamp.className = 'log-timestamp';
        timestamp.textContent = new Date().toLocaleTimeString();

        const content = document.createElement('div');
        content.innerHTML = message;

        logEntry.appendChild(timestamp);
        logEntry.appendChild(content);
        logBox.appendChild(logEntry);
        logBox.scrollTop = logBox.scrollHeight;
    }

    /**
     * SSE ì—°ê²° ì„¤ì •
     */
    function connect() {
        // ê¸°ì¡´ ì—°ê²° ì¢…ë£Œ
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        // ì—°ê²° ì¤‘ ìƒíƒœë¡œ ë³€ê²½
        updateStatus('connecting');

        userId = parseInt(userIdInput.value);
        if (isNaN(userId) || userId <= 0) {
            addLog('ìœ íš¨í•œ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
            updateStatus('disconnected');
            return;
        }

        addLog(`ì‚¬ìš©ì ID ${userId}ë¡œ SSE ì—°ê²° ì‹œë„...`);

        try {
            // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
            const timestamp = new Date().getTime();
            eventSource = new EventSource(`${API_BASE_URL}/subscribe/${userId}?t=${timestamp}`);

            // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
            registerEventHandlers();

        } catch (error) {
            addLog(`ì—°ê²° ì‹œë„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            updateStatus('disconnected');
        }
    }

    /**
     * SSE ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
     */
    function registerEventHandlers() {
        // ì—°ê²° ì´ë²¤íŠ¸
        eventSource.addEventListener("connect", (e) => {
            const data = JSON.parse(e.data);
            updateStatus('connected');
            retryCount = 0; // ì—°ê²° ì„±ê³µ ì‹œ ì¬ì‹œë„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”

            addLog(`ğŸ”Œ ì—°ê²° ì„±ê³µ! ì•¡í‹°ë¸Œ ì‚¬ìš©ì: ${data.activeUsers}ëª…`);
        });

        // ì•Œë¦¼ ì´ë²¤íŠ¸
        eventSource.addEventListener("alarm", (e) => {
            const alarm = JSON.parse(e.data);
            const formattedTime = new Date(alarm.timestamp).toLocaleTimeString();
            addLog(`ğŸ”” <strong>ì•Œë¦¼ ë„ì°©!</strong><br>
                        ì‹œê°„: ${formattedTime}<br>
                        ë‚´ìš©: ${alarm.content}<br>
                        ìœ í˜•: ${alarm.type || 'ê¸°ë³¸'}`, 'alarm');

            // ì•Œë¦¼ íƒ­ì´ ë³´ì´ëŠ” ê²½ìš° ëª©ë¡ ê°±ì‹ 
            if (activeTab === 'notifications') {
                loadNotifications();
            }
        });

        // ì½ì§€ ì•Šì€ ì•Œë¦¼ ì¹´ìš´íŠ¸ ì´ë²¤íŠ¸
        eventSource.addEventListener("unread", (e) => {
            const data = JSON.parse(e.data);
            unreadCountDiv.textContent = `ì½ì§€ ì•Šì€ ì•Œë¦¼: ${data.count}ê°œ`;
        });

        // ìµœê·¼ ì•Œë¦¼ ì´ë²¤íŠ¸
        eventSource.addEventListener("recent-alarms", (e) => {
            const alarms = JSON.parse(e.data);
            if (alarms.length > 0) {
                addLog(`ğŸ“‹ ìµœê·¼ ì•Œë¦¼ ${alarms.length}ê°œ ë¡œë“œë¨`, 'info');
                // ì•Œë¦¼ íƒ­ì´ ë³´ì´ëŠ” ê²½ìš° ëª©ë¡ ê°±ì‹ 
                if (activeTab === 'notifications') {
                    loadNotifications();
                }
            }
        });

        // ì•Œë¦¼ ì‚­ì œ ì´ë²¤íŠ¸
        eventSource.addEventListener("alarm-deleted", (e) => {
            const data = JSON.parse(e.data);
            addLog(`ğŸ—‘ï¸ ì•Œë¦¼ ${data.alarmId} ì‚­ì œë¨`, 'info');
            unreadCountDiv.textContent = `ì½ì§€ ì•Šì€ ì•Œë¦¼: ${data.unreadCount}ê°œ`;

            // ì•Œë¦¼ íƒ­ì´ ë³´ì´ëŠ” ê²½ìš° ëª©ë¡ ê°±ì‹ 
            if (activeTab === 'notifications') {
                loadNotifications();
            }
        });

        // ëª¨ë“  ì•Œë¦¼ ì‚­ì œ ì´ë²¤íŠ¸
        eventSource.addEventListener("all-alarms-deleted", (e) => {
            addLog(`ğŸ—‘ï¸ ëª¨ë“  ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
            unreadCountDiv.textContent = `ì½ì§€ ì•Šì€ ì•Œë¦¼: 0ê°œ`;

            // ì•Œë¦¼ íƒ­ì´ ë³´ì´ëŠ” ê²½ìš° ëª©ë¡ ê°±ì‹ 
            if (activeTab === 'notifications') {
                loadNotifications();
            }
        });

        // í•‘-í ì´ë²¤íŠ¸
        eventSource.addEventListener("ping", (e) => {
            addLog(`ğŸ“ Ping-Pong`, 'info');
        });

        // í•˜íŠ¸ë¹„íŠ¸ ì´ë²¤íŠ¸ - ë¡œê·¸ì— í‘œì‹œí•˜ì§€ ì•Šê³  ë‚´ë¶€ì ìœ¼ë¡œë§Œ ì²˜ë¦¬
        eventSource.addEventListener("heartbeat", (e) => {
            console.log("â¤ï¸ Heartbeat received");
        });

        // ì¼ë°˜ ë©”ì‹œì§€ ì´ë²¤íŠ¸ (open ì´ë²¤íŠ¸)
        eventSource.onopen = () => {
            addLog(`ğŸ“¡ SSE ìŠ¤íŠ¸ë¦¼ ì—´ë¦¼`);
        };

        // ì˜¤ë¥˜ ì´ë²¤íŠ¸
        eventSource.onerror = (e) => {
            addLog(`âŒ ì˜¤ë¥˜ ë°œìƒ! ì¬ì—°ê²° ì‹œë„...`, 'error');
            updateStatus('disconnected');

            // ì—°ê²° ëŠê¹€ ì²˜ë¦¬ ë° ì¬ì—°ê²° ë¡œì§
            eventSource.close();

            // ì¬ì‹œë„ íšŸìˆ˜ ì œí•œ í™•ì¸
            if (retryCount < maxRetry) {
                retryCount++;
                const timeout = retryInterval * retryCount;

                addLog(`${timeout / 1000}ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„ (${retryCount}/${maxRetry})...`, 'info');

                // ì´ì „ íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                }

                // ì§€ìˆ˜ ë°±ì˜¤í”„ë¡œ ì¬ì‹œë„
                reconnectTimeout = setTimeout(() => {
                    connect();
                }, timeout);
            } else {
                addLog(`ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. ìˆ˜ë™ìœ¼ë¡œ ì¬ì—°ê²° í•´ì£¼ì„¸ìš”.`, 'error');
            }
        };
    }

    /**
     * ì—°ê²° ì¢…ë£Œ
     */
    function disconnect() {
        if (eventSource) {
            addLog(`SSE ì—°ê²° ì¢…ë£Œ`, 'info');
            eventSource.close();
            eventSource = null;
            updateStatus('disconnected');

            // ì¬ì—°ê²° íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
        }
    }

    /**
     * ë¡œê·¸ ì§€ìš°ê¸°
     */
    function clearLog() {
        logBox.innerHTML = '';
        addLog('ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
    }

    /**
     * ì—°ê²° ìƒíƒœ í™•ì¸ (Ping)
     */
    function pingConnection() {
        fetch(`${API_BASE_URL}/ping/${userId}`)
            .then(response => response.json())
            .then(data => {
                addLog(`Ping ê²°ê³¼: ${data.message}`, 'info');
            })
            .catch(error => {
                addLog(`Ping ì‹¤íŒ¨: ${error.message}`, 'error');
            });
    }

    /**
     * ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
     */
    function markAllAsRead() {
        fetch(`${API_BASE_URL}/read-all/${userId}`, { method: 'PUT' })
            .then(response => {
                if (response.ok) {
                    addLog('ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.', 'info');
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨');
                    });
                }
            })
            .catch(error => {
                addLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
            });
    }

    /**
     * ëª¨ë“  ì•Œë¦¼ ì‚­ì œ
     */
    function deleteAllAlarms() {
        if (!confirm('ëª¨ë“  ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        fetch(`${API_BASE_URL}/all/${userId}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    addLog('ëª¨ë“  ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    notificationsListBox.innerHTML = 'ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.';
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨');
                    });
                }
            })
            .catch(error => {
                addLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
            });
    }

    /**
     * ì•Œë¦¼ ëª©ë¡ ë¡œë“œ
     */
    function loadNotifications() {
        notificationsListBox.innerHTML = '<div class="log-item info-log">ì•Œë¦¼ ëª©ë¡ ë¡œë“œ ì¤‘...</div>';

        fetch(`${API_BASE_URL}/list/${userId}`)
            .then(response => response.json())
            .then(alarms => {
                displayNotifications(alarms);
            })
            .catch(error => {
                notificationsListBox.innerHTML = `<div class="log-item error-log">ì•Œë¦¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            });
    }

    /**
     * ì•Œë¦¼ ëª©ë¡ í‘œì‹œ
     */
    function displayNotifications(alarms) {
        if (!alarms || alarms.length === 0) {
            notificationsListBox.innerHTML = '<div class="log-item info-log">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        notificationsListBox.innerHTML = '';

        alarms.forEach(alarm => {
            const alarmItem = document.createElement('div');
            alarmItem.className = `log-item ${alarm.isRead === 'Y' ? 'info-log' : 'alarm-log'}`;

            const timestamp = new Date(alarm.createdAt).toLocaleString();

            alarmItem.innerHTML = `
                    <div class="log-timestamp">${timestamp}</div>
                    <div><strong>${alarm.type || 'ì•Œë¦¼'}</strong></div>
                    <div>${alarm.content}</div>
                    <div style="margin-top:10px">
                        <button class="small-btn" onclick="markAlarmAsRead(${alarm.alarmSeq})" ${alarm.isRead === 'Y' ? 'disabled' : ''}>
                            ${alarm.isRead === 'Y' ? 'ì½ìŒ' : 'ì½ìŒ ì²˜ë¦¬'}
                        </button>
                        <button class="small-btn danger-btn" onclick="deleteAlarm(${alarm.alarmSeq})">ì‚­ì œ</button>
                    </div>
                `;

            notificationsListBox.appendChild(alarmItem);
        });
    }

    /**
     * íŠ¹ì • ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
     */
    function markAlarmAsRead(alarmId) {
        fetch(`${API_BASE_URL}/read/${alarmId}`, { method: 'PUT' })
            .then(response => {
                if (response.ok) {
                    loadNotifications();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨');
                    });
                }
            })
            .catch(error => {
                addLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
            });
    }

    /**
     * íŠ¹ì • ì•Œë¦¼ ì‚­ì œ
     */
    function deleteAlarm(alarmId) {
        fetch(`${API_BASE_URL}/${alarmId}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    loadNotifications();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨');
                    });
                }
            })
            .catch(error => {
                addLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
            });
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    connectButton.addEventListener('click', connect);
    disconnectButton.addEventListener('click', disconnect);
    clearButton.addEventListener('click', clearLog);
    pingButton.addEventListener('click', pingConnection);
    markAllReadButton.addEventListener('click', markAllAsRead);
    deleteAllButton.addEventListener('click', deleteAllAlarms);

    // ì—”í„°í‚¤ë¡œ ì—°ê²°
    userIdInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            connect();
        }
    });

    // ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ (ì•Œë¦¼ ì¡°ì‘ìš©)
    window.markAlarmAsRead = markAlarmAsRead;
    window.deleteAlarm = deleteAlarm;

    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    updateStatus('disconnected');
</script>